/* This compressed file is part of Xinha. For uncompressed sources, forum, and bug reports, go to xinha.org */
/* This file is part of version 0.96beta2 released Fri, 20 Mar 2009 11:01:14 +0100 */
Linker.prototype._createLink=function(n){if(!this._dialog){this._dialog=new Linker.Dialog(this)}if(!n&&this.editor.selectionEmpty(this.editor.getSelection())){alert(this._lc("You must select some text before making a new link."));return false}var k={type:"url",href:"http://www.example.com/",target:"",p_width:"",p_height:"",p_options:["menubar=no","toolbar=yes","location=no","status=no","scrollbars=yes","resizeable=yes"],to:"alice@example.com",subject:"",body:"",anchor:""};if(n&&n.tagName.toLowerCase()=="a"){var b=this.editor.fixRelativeLinks(n.getAttribute("href"));var c=b.match(/^mailto:(.*@[^?&]*)(\?(.*))?$/);var g=b.match(/^#(.*)$/);if(c){k.type="mailto";k.to=c[1];if(c[3]){var l=c[3].split("&");for(var o=0;o<l.length;o++){var e=l[o].match(/(subject|body)=(.*)/);if(e){k[e[1]]=decodeURIComponent(e[2])}}}}else{if(g){k.type="anchor";k.anchor=g[1]}else{if(n.getAttribute("onclick")){var c=n.getAttribute("onclick").match(/window\.open\(\s*this\.href\s*,\s*'([a-z0-9_]*)'\s*,\s*'([a-z0-9_=,]*)'\s*\)/i);k.href=b?b:"";k.target="popup";k.p_name=c[1];k.p_options=[];var l=c[2].split(",");for(var o=0;o<l.length;o++){var f=l[o].match(/(width|height)=([0-9]+)/);if(f){k["p_"+f[1]]=parseInt(f[2])}else{k.p_options.push(l[o])}}}else{k.href=b;k.target=n.target}}}}var h=this;this.a=n;var d=function(){var w=h.a;var x=h._dialog.hide();var v={href:"",target:"",title:"",onclick:""};if(x.type=="url"){if(x.href){v.href=x.href.trim();v.target=x.target;if(x.target=="popup"){if(x.p_width){x.p_options.push("width="+x.p_width)}if(x.p_height){x.p_options.push("height="+x.p_height)}v.onclick="if(window.parent && window.parent.Xinha){return false}window.open(this.href, '"+(x.p_name.replace(/[^a-z0-9_]/i,"_"))+"', '"+x.p_options.join(",")+"');return false;"}}}else{if(x.type=="anchor"){if(x.anchor){v.href=x.anchor.value}}else{if(x.to){v.href="mailto:"+x.to;if(x.subject){v.href+="?subject="+encodeURIComponent(x.subject)}if(x.body){v.href+=(x.subject?"&":"?")+"body="+encodeURIComponent(x.body)}}}}if(v.href){v.href=v.href.trim()}if(w&&w.tagName.toLowerCase()=="a"){if(!v.href){if(confirm(h._dialog._lc("Are you sure you wish to remove this link?"))){var q=w.parentNode;while(w.hasChildNodes()){q.insertBefore(w.removeChild(w.childNodes[0]),w)}q.removeChild(w);h.editor.updateToolbar();return}}else{for(var s in v){w.setAttribute(s,v[s])}if(Xinha.is_ie){if(/mailto:([^?<>]*)(\?[^<]*)?$/i.test(w.innerHTML)){w.innerHTML=RegExp.$1}}}}else{if(!v.href){return true}var t=Xinha.uniq("http://www.example.com/Link");h.editor._doc.execCommand("createlink",false,t);var m=h.editor._doc.getElementsByTagName("a");for(var s=0;s<m.length;s++){var u=m[s];if(u.href==t){if(!w){w=u}for(var r in v){u.setAttribute(r,v[r])}}}}h.editor.selectNodeContents(w);h.editor.updateToolbar()};this._dialog.show(k,d)};Linker.prototype._getSelectedAnchor=function(){var d=this.editor.getSelection();var c=this.editor.createRange(d);var b=this.editor.activeElement(d);if(b!=null&&b.tagName.toLowerCase()=="a"){return b}else{b=this.editor._getFirstAncestor(d,"a");if(b!=null){return b}}return null};Linker.Dialog_dTrees=[];Linker.Dialog=function(a){var b=this;this.Dialog_nxtid=0;this.linker=a;this.id={};this.ready=false;this.dialog=false;this._prepareDialog()};Linker.Dialog.prototype._prepareDialog=function(){var lDialog=this;var linker=this.linker;var files=this.linker.files;var dialog=this.dialog=new Xinha.Dialog(linker.editor,Linker.html,"Linker",{width:600,height:400});var dTreeName=Xinha.uniq("dTree_");this.dTree=new dTree(dTreeName,Xinha.getPluginDir("Linker")+"/dTree/");eval(dTreeName+" = this.dTree");this.dTree.add(this.Dialog_nxtid++,-1,linker.lConfig.treeCaption,null,linker.lConfig.treeCaption);this.makeNodes(files,0);var ddTree=this.dialog.getElementById("dTree");ddTree.innerHTML="";ddTree.style.overflow="auto";ddTree.style.height="300px";if(Xinha.is_ie){ddTree.style.styleFloat="left"}else{ddTree.style.cssFloat="left"}ddTree.style.backgroundColor="white";this.ddTree=ddTree;this.dTree._linker_premade=this.dTree.toString();var options=this.dialog.getElementById("options");options.style.width=320+"px";options.style.overflow="auto";this.dialog.rootElem.style.paddingBottom="0";this.dialog.onresize=function(){var h=parseInt(dialog.height)-dialog.getElementById("h1").offsetHeight;var w=parseInt(dialog.width)-330;if(w<0){w=0}if(h<0){h=0}lDialog.ddTree.style.height=h+"px";lDialog.ddTree.style.width=w+"px"};var self=this;this.dialog.getElementById("type_url").onclick=function(){self.showOptionsForType("url")};this.dialog.getElementById("type_mailto").onclick=function(){self.showOptionsForType("mailto")};this.dialog.getElementById("type_anchor").onclick=function(){self.showOptionsForType("anchor")};var hidePopupOptions=function(){self.showOptionsForTarget("none")};this.dialog.getElementById("noTargetRadio").onclick=hidePopupOptions;this.dialog.getElementById("sameWindowRadio").onclick=hidePopupOptions;this.dialog.getElementById("newWindowRadio").onclick=hidePopupOptions;this.dialog.getElementById("popupWindowRadio").onclick=function(){self.showOptionsForTarget("popup")};this.ready=true;ddTree=null;Xinha.freeLater(lDialog,"ddTree");options=null};Linker.Dialog.prototype.makeNodes=function(d,b){for(var a=0;a<d.length;a++){if(typeof d[a]=="string"){this.dTree.add(Linker.nxtid++,b,d[a].replace(/^.*\//,""),"javascript:document.getElementsByName('"+this.dialog.id.href+"')[0].value=decodeURIComponent('"+encodeURIComponent(d[a])+"');document.getElementsByName('"+this.dialog.id.type+"')[0].click();document.getElementsByName('"+this.dialog.id.href+"')[0].focus();void(0);",d[a])}else{if(typeof d[a]=="object"&&d[a]&&typeof d[a].length==="number"){var f=this.Dialog_nxtid++;this.dTree.add(f,b,d[a][0].replace(/^.*\//,""),null,d[a][0]);this.makeNodes(d[a][1],f)}else{if(typeof d[a]=="object"){if(d[a].children){var f=this.Dialog_nxtid++}else{var f=Linker.nxtid++}if(d[a].title){var e=d[a].title}else{if(d[a].url){var e=d[a].url.replace(/^.*\//,"")}else{var e="no title defined"}}if(d[a].url){var c="javascript:document.getElementsByName('"+this.dialog.id.href+"')[0].value=decodeURIComponent('"+encodeURIComponent(d[a].url)+"');document.getElementsByName('"+this.dialog.id.type+"')[0].click();document.getElementsByName('"+this.dialog.id.href+"')[0].focus();void(0);"}else{var c=""}this.dTree.add(f,b,e,c,e);if(d[a].children){this.makeNodes(d[a].children,f)}}}}}};Linker.Dialog.prototype._lc=Linker.prototype._lc;Linker.Dialog.prototype.show=function(l,q,s){if(!this.ready){var g=this;window.setTimeout(function(){g.show(l,q,s)},100);return}if(this.ddTree.innerHTML==""){this.ddTree.innerHTML=this.dTree._linker_premade}this.showOptionsForType(l.type);this.showOptionsForTarget(l.target);var j=this.dialog.getElementById("anchor");for(var h=j.length;h>=0;h--){j[h]=null}var k=this.linker.editor.getHTML();var b=new Array();var e=k.match(/<a[^>]+name="([^"]+)"/gi);if(e){for(h=0;h<e.length;h++){var d=e[h].match(/name="([^"]+)"/i);if(!b.contains(d[1])){b.push(d[1])}}}e=k.match(/id="([^"]+)"/gi);if(e){for(h=0;h<e.length;h++){d=e[h].match(/id="([^"]+)"/i);if(!b.contains(d[1])){b.push(d[1])}}}for(h=0;h<b.length;h++){var c=new Option(b[h],"#"+b[h],false,(l.anchor==b[h]));j[j.length]=c}if(this.linker.lConfig.disableMailto){this.dialog.getElementById("mailtofieldset").style.display="none"}if(j.length==0||this.linker.lConfig.disableAnchors){this.dialog.getElementById("anchorfieldset").style.display="none";if(this.linker.lConfig.disableMailto){this.dialog.getElementById("type").style.display="none"}}var p=this.linker.lConfig.disableTargetTypes;if(typeof p=="undefined"){p=[]}else{if(typeof p=="string"){p=[p]}}for(var h=0;h<p.length;h++){this.dialog.getElementById(p[h]).style.display="none"}if(p.length==3){if(p.contains("popupWindow")){this.dialog.getElementById("target_options").style.display="none"}else{this.dialog.getElementById("popupWindowRadio").style.display="none";this.showOptionsForTarget("popup")}}var a=new Array();if(!p.contains("noTarget")){a.push("noTargetRadio")}if(!p.contains("sameWindow")){a.push("sameWindowRadio")}if(!p.contains("newWindow")){a.push("newWindowRadio")}if(!p.contains("popupWindow")){a.push("popupWindowRadio")}if(l.href=="http://www.example.com/"&&l.to=="alice@example.com"){this.dialog.getElementById("clear").style.display="none"}else{var r=this.dialog.getElementById("clear");r.style.display="";if(q){r.onclick=function(){g.removeLink(q)}}}var o=this.dialog;var g=this;if(q){this.dialog.getElementById("ok").onclick=q}else{this.dialog.getElementById("ok").onclick=function(){g.hide()}}if(s){this.dialog.getElementById("cancel").onclick=s}else{this.dialog.getElementById("cancel").onclick=function(){g.hide()}}this.linker.editor.disableToolbar(["fullscreen","linker"]);this.dialog.show(l);var f=false;for(var h=0;h<a.length;h++){if(this.dialog.getElementById(a[h]).checked==true){f=true;break}}if(!f&&a.length>0){this.dialog.getElementById(a[0]).checked=true}this.dialog.onresize()};Linker.Dialog.prototype.hide=function(){this.linker.editor.enableToolbar();return this.dialog.hide()};Linker.Dialog.prototype.removeLink=function(a){this.dialog.getElementById("href").value="";this.dialog.getElementById("to").value="";return a()};Linker.Dialog.prototype.showOptionsForType=function(c){var a=this.dialog.getElementById("urltable");var d=this.dialog.getElementById("mailtable");var b=this.dialog.getElementById("anchortable");if(c=="anchor"){b.style.display="";a.style.display="none";d.style.display="none"}else{if(c=="mailto"){d.style.display="";a.style.display="none";b.style.display="none"}else{a.style.display="";d.style.display="none";b.style.display="none"}}};Linker.Dialog.prototype.showOptionsForTarget=function(a){var b=this.dialog.getElementById("popuptable");b.style.display=a=="popup"?"":"none"};