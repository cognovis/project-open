/* This compressed file is part of Xinha. For uncompressed sources, forum, and bug reports, go to xinha.org */
/* This file is part of version 0.96beta2 released Fri, 20 Mar 2009 11:01:14 +0100 */
Xinha.Config.prototype.TableOperations={showButtons:true};function TableOperations(e){this.editor=e;var a=e.config;var h=TableOperations.btnList;var b=this;a.removeToolbarElement(" inserttable toggleborders ");var f=["linebreak","inserttable","toggleborders"];for(var d=0;d<h.length;++d){var c=h[d];if(!c){if(a.TableOperations.showButtons){f.push("separator")}}else{var g="TO-"+c[0];a.registerButton(g,Xinha._lc(c[2],"TableOperations"),e.imgURL(c[0]+".gif","TableOperations"),false,function(i,j){b.buttonPress(i,j)},c[1]);if(a.TableOperations.showButtons){f.push(g)}}}a.toolbar.push(f);if(typeof PopupWin=="undefined"){Xinha._loadback(_editor_url+"modules/Dialogs/popupwin.js")}if(typeof Xinha.InlineStyler=="undefined"){Xinha._loadback(_editor_url+"modules/InlineStyler/InlineStyler.js")}}TableOperations._pluginInfo={name:"TableOperations",version:"1.0",developer:"Mihai Bazon",developer_url:"http://dynarch.com/mishoo/",c_owner:"Mihai Bazon",sponsor:"Zapatec Inc.",sponsor_url:"http://www.bloki.com",license:"htmlArea"};TableOperations.prototype._lc=function(a){return Xinha._lc(a,"TableOperations")};TableOperations.prototype.getClosest=function(c){var f=this.editor;var e=f.getAllAncestors();var a=null;c=(""+c).toLowerCase();for(var b=0;b<e.length;++b){var d=e[b];if(d.tagName.toLowerCase()==c){a=d;break}}return a};TableOperations.prototype.buttonPress=function(e,k){this.editor=e;var f=Xinha.is_gecko?"<br />":"";function g(I){var H=I.getElementsByTagName("td");for(var G=H.length;--G>=0;){var J=H[G];J.rowSpan=1;J.innerHTML=f}}function y(L){var K=parseInt(""+L.rowSpan);var J=parseInt(""+L.colSpan);L.rowSpan=1;a=L.parentNode;var H=a.rowIndex;var i=a.parentNode.rows;var G=L.cellIndex;while(--K>0){a=i[++H];var I=e._doc.createElement("td");I.colSpan=L.colSpan;I.innerHTML=f;a.insertBefore(I,a.cells[G])}e.forceRedraw();e.updateToolbar()}function s(I){var H=parseInt(""+I.colSpan);I.colSpan=1;a=I.parentNode;var G=I.nextSibling;while(--H>0){var i=e._doc.createElement("td");i.rowSpan=I.rowSpan;i.innerHTML=f;a.insertBefore(i,G)}e.forceRedraw();e.updateToolbar()}function F(I){var H=parseInt(""+I.colSpan);s(I);var i=I.parentNode.cells;var G=I.cellIndex;while(H-->0){y(i[G++])}}function z(i){var G=i.nextSibling;while(G&&G.nodeType!=1){G=G.nextSibling}if(!G){G=i.previousSibling;while(G&&G.nodeType!=1){G=G.previousSibling}}if(!G){G=i.parentNode}e.selectNodeContents(G)}function l(S,H,O,G,J){var V=[];var T=[];try{for(C=O;C<O+J;C++){var U=S.rows[C];for(K=H;K<H+G;K++){if(U.cells[K].colSpan>1||U.cells[K].rowSpan>1){F(U.cells[K])}T.push(U.cells[K])}if(T.length>0){V.push(T);T=[]}}}catch(N){alert("Invalid selection");return false}var Q=V[0][0].parentNode.rowIndex;var P=V[V.length-1][0].parentNode.rowIndex;var M=V[V.length-1][0].rowSpan;var L="";for(C=0;C<V.length;++C){var T=V[C];for(var K=0;K<T.length;++K){var R=T[K];L+=R.innerHTML;(C||K)&&(R.parentNode.removeChild(R))}}var I=V[0][0];I.innerHTML=L;I.rowSpan=P-Q+M;var i=0;for(K=0;K<V[0].length;K++){i+=V[0][K].colSpan}I.colSpan=i;e.selectNodeContents(I);e.forceRedraw();e.focusEditor()}switch(k){case"TO-row-insert-above":case"TO-row-insert-under":var a=this.getClosest("tr");if(!a){break}var q=a.cloneNode(true);g(q);a.parentNode.insertBefore(q,/under/.test(k)?a.nextSibling:a);e.forceRedraw();e.focusEditor();break;case"TO-row-delete":var a=this.getClosest("tr");if(!a){break}var u=a.parentNode;if(u.rows.length==1){alert(Xinha._lc("Xinha cowardly refuses to delete the last row in table.","TableOperations"));break}z(a);u.removeChild(a);e.forceRedraw();e.focusEditor();e.updateToolbar();break;case"TO-row-split":var m=this.getClosest("td");if(!m){break}y(m);break;case"TO-col-insert-before":case"TO-col-insert-after":var m=this.getClosest("td");if(!m){break}var p=m.parentNode.parentNode.rows;var j=m.cellIndex;var n=(m.parentNode.cells.length==j+1);for(var C=p.length;--C>=0;){var a=p[C];var B=e._doc.createElement("td");B.innerHTML=f;if(n&&Xinha.is_ie){a.insertBefore(B)}else{var h=a.cells[j+(/after/.test(k)?1:0)];a.insertBefore(B,h)}}e.focusEditor();break;case"TO-col-split":var m=this.getClosest("td");if(!m){break}s(m);break;case"TO-col-delete":var m=this.getClosest("td");if(!m){break}var j=m.cellIndex;if(m.parentNode.cells.length==1){alert(Xinha._lc("Xinha cowardly refuses to delete the last column in table.","TableOperations"));break}z(m);var p=m.parentNode.parentNode.rows;for(var C=p.length;--C>=0;){var a=p[C];a.removeChild(a.cells[j])}e.forceRedraw();e.focusEditor();e.updateToolbar();break;case"TO-cell-split":var m=this.getClosest("td");if(!m){break}F(m);break;case"TO-cell-insert-before":case"TO-cell-insert-after":var m=this.getClosest("td");if(!m){break}var a=m.parentNode;var B=e._doc.createElement("td");B.innerHTML=f;a.insertBefore(B,/after/.test(k)?m.nextSibling:m);e.forceRedraw();e.focusEditor();break;case"TO-cell-delete":var m=this.getClosest("td");if(!m){break}if(m.parentNode.cells.length==1){alert(Xinha._lc("Xinha cowardly refuses to delete the last cell in row.","TableOperations"));break}z(m);m.parentNode.removeChild(m);e.forceRedraw();e.updateToolbar();break;case"TO-cell-merge":var A=e._getSelection();if(!Xinha.is_ie&&A.rangeCount>1){var t=A.getRangeAt(0);var m=t.startContainer.childNodes[t.startOffset];var a=m.parentNode;var o=m.cellIndex;var r=a.rowIndex;var x=0;var w=r;var c=0;var v=0;var d,E;for(C=0;C<A.rangeCount;C++){t=A.getRangeAt(C);d=t.startContainer.childNodes[t.startOffset];E=d.parentNode;if(E.rowIndex!=w){w=E.rowIndex;v=0}v+=d.colSpan;if(v>c){c=v}if(E.rowIndex+d.rowSpan-1>x){x=E.rowIndex+d.rowSpan-1}}var b=x-r+1;var D=a.parentNode;l(D,o,r,c,b)}else{var m=this.getClosest("td");if(!m){alert(Xinha._lc("Please click into some cell","TableOperations"));break}var a=m.parentNode;var o=m.cellIndex;var r=a.rowIndex;this.dialogMerge(l,o,r)}break;case"TO-table-prop":this.dialogTableProperties();break;case"TO-row-prop":this.dialogRowCellProperties(false);break;case"TO-cell-prop":this.dialogRowCellProperties(true);break;default:alert("Button ["+k+"] not yet implemented")}};TableOperations.btnList=[["table-prop","table","Table properties"],null,["row-prop","tr","Row properties"],["row-insert-above","tr","Insert row before"],["row-insert-under","tr","Insert row after"],["row-delete","tr","Delete row"],["row-split","td[rowSpan!=1]","Split row"],null,["col-insert-before","td","Insert column before"],["col-insert-after","td","Insert column after"],["col-delete","td","Delete column"],["col-split","td[colSpan!=1]","Split column"],null,["cell-prop","td","Cell properties"],["cell-insert-before","td","Insert cell before"],["cell-insert-after","td","Insert cell after"],["cell-delete","td","Delete cell"],["cell-merge","tr","Merge cells"],["cell-split","td[colSpan!=1,rowSpan!=1]","Split cell"]];TableOperations.prototype.dialogMerge=function(g,h,e){var f=this.getClosest("table");var b=this;var d=this.editor;if(!this.dialogMergeCellsHtml){Xinha._getback(Xinha.getPluginDir("TableOperations")+"/popups/dialogMergeCells.html",function(i){b.dialogMergeCellsHtml=i;b.dialogMerge(g,h,e)});return}if(!this.dialogMergeCells){this.dialogMergeCells=new Xinha.Dialog(d,this.dialogMergeCellsHtml,"TableOperations",{width:400});this.dialogMergeCells.getElementById("cancel").onclick=function(){b.dialogMergeCells.hide()}}var c=this.dialogMergeCells;function a(){c.hide();no_cols=parseInt(c.getElementById("f_cols").value,10)+1;no_rows=parseInt(c.getElementById("f_rows").value,10)+1;g(f,h,e,no_cols,no_rows);return}this.dialogMergeCells.getElementById("ok").onclick=a;this.dialogMergeCells.show();this.dialogMergeCells.getElementById("f_cols").focus()};TableOperations.prototype.dialogTableProperties=function(){var k=this.getClosest("table");var l=this;var d=this.editor;if(!this.dialogTablePropertiesHtml){Xinha._getback(Xinha.getPluginDir("TableOperations")+"/popups/dialogTable.html",function(m){l.dialogTablePropertiesHtml=m;l.dialogTableProperties()});return}if(!this.dialogTable){this.dialogTable=new Xinha.Dialog(d,this.dialogTablePropertiesHtml,"TableOperations",{width:440});this.dialogTable.getElementById("cancel").onclick=function(){l.dialogTable.hide()}}var g=this.dialogTable;var c=new Xinha.InlineStyler(k,this.editor,g);function i(){var q=g.hide();c.applyStyle(q);for(var n in q){if(typeof q[n]=="function"){continue}var p=q[n];if(typeof p=="object"&&p!=null&&p.tagName){p=p.value}switch(n){case"caption":if(/\S/.test(p)){var m=k.getElementsByTagName("caption")[0];if(!m){m=g.editor._doc.createElement("caption");k.insertBefore(m,k.firstChild)}m.innerHTML=p}else{var m=k.getElementsByTagName("caption")[0];if(m){m.parentNode.removeChild(m)}}break;case"summary":k.summary=p;break;case"width":k.style.width=(""+p)+q.f_unit;break;case"align":k.align=p;break;case"spacing":k.cellSpacing=p;break;case"padding":k.cellPadding=p;break;case"borders":k.border=p;break;case"frames":k.frame=p;break;case"rules":k.rules=p;break}}l.editor.forceRedraw();l.editor.focusEditor();l.editor.updateToolbar();var o=k.style.borderCollapse;k.style.borderCollapse="collapse";k.style.borderCollapse="separate";k.style.borderCollapse=o}var a=c.createStyleLayoutFieldset();var b=g.getElementById("TO_layout");b.replaceChild(a,b.firstChild);var j=c.createStyleFieldset();b=g.getElementById("TO_style");b.replaceChild(j,b.firstChild);this.dialogTable.getElementById("ok").onclick=i;var h={};var e=k.getElementsByTagName("caption")[0];if(e){h.caption=e.innerHTML}else{h.caption=""}h.summary=k.summary;h.spacing=k.cellSpacing;h.padding=k.cellPadding;var f=k.border;h.frames=k.frame;h.rules=k.rules;this.dialogTable.show(h)};TableOperations.prototype.dialogRowCellProperties=function(h){var d=this.getClosest(h?"td":"tr");var j=this.getClosest("table");var k=this;var e=this.editor;if(!k.dialogRowCellPropertiesHtml){Xinha._getback(Xinha.getPluginDir("TableOperations")+"/popups/dialogRowCell.html",function(l){k.dialogRowCellPropertiesHtml=l;k.dialogRowCellProperties(h)});return}if(!this.dialogRowCell){this.dialogRowCell=new Xinha.Dialog(e,k.dialogRowCellPropertiesHtml,"TableOperations",{width:440});this.dialogRowCell.getElementById("cancel").onclick=function(){k.dialogRowCell.hide()}}var f=this.dialogRowCell;f.getElementById("title").innerHTML=h?Xinha._lc("Cell Properties","TableOperations"):Xinha._lc("Row Properties","TableOperations");var c=new Xinha.InlineStyler(d,k.editor,f);function g(){var m=f.hide();c.applyStyle(m);k.editor.forceRedraw();k.editor.focusEditor();k.editor.updateToolbar();var l=j.style.borderCollapse;j.style.borderCollapse="collapse";j.style.borderCollapse="separate";j.style.borderCollapse=l}var a=c.createStyleLayoutFieldset();var b=f.getElementById("TO_layout");b.replaceChild(a,b.firstChild);var i=c.createStyleFieldset();b=f.getElementById("TO_style");b.replaceChild(i,b.firstChild);this.dialogRowCell.getElementById("ok").onclick=g;this.dialogRowCell.show()};