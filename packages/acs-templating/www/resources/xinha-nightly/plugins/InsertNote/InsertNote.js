/* This compressed file is part of Xinha. For uncompressed sources, forum, and bug reports, go to xinha.org */
/* This file is part of version 0.96beta2 released Fri, 20 Mar 2009 11:01:14 +0100 */
function InsertNote(c){this.editor=c;var a=c.config;var b=this;a.registerButton({id:"insert-note",tooltip:this._lc("Insert footnote"),image:c.imgURL("insert-note.gif","InsertNote"),textMode:false,action:function(){b.show()}});a.addToolbarElement("insert-note","createlink",1)}InsertNote._pluginInfo={name:"InsertNote",version:"0.4",developer:"Nicholas Bergson-Shilcock",developer_url:"http://www.nicholasbs.com",c_owner:"Nicholas Bergson-Shilcock",sponsor:"The Open Planning Project",sponsor_url:"http://topp.openplans.org",license:"LGPL"};InsertNote.prototype.onGenerateOnce=function(){this.notes={};this.noteNums={};this.ID_PREFIX="InsertNoteID_";this.MARKER_SUFFIX="_marker";this.MARKER_CLASS="InsertNoteMarker";this.LINK_BACK_SUFFIX="_LinkBacks";this.NOTE_LIST_ID="InsertNote_NoteList";this._prepareDialog()};InsertNote.prototype._prepareDialog=function(){var a=this;var b=this.editor;if(!this.html){Xinha._getback(Xinha.getPluginDir("InsertNote")+"/dialog.html",function(c){a.html=c;a._prepareDialog()});return}this.dialog=new Xinha.Dialog(b,this.html,"InsertNote",{width:400,closeOnEscape:true,resizable:false,centered:true,modal:true});this.dialog.getElementById("ok").onclick=function(){a.apply()};this.dialog.getElementById("cancel").onclick=function(){a.dialog.hide()};this.dialog.getElementById("noteMenu").onchange=function(){var c=this.options[this.selectedIndex].value;var e=a.notes[c]||"";var d=a.dialog.getElementById("noteContent");d.value=e;if(e){d.disabled=true}else{d.disabled=false;d.focus()}};this.ready=true};InsertNote.prototype.show=function(){if(!this.ready){var j=this;window.setTimeout(function(){j.show()},80);return}var d=this.editor;var f=document;this.repairNotes();if(this.cursorInFootnote()){alert("Footnotes cannot be inserted inside of other footnotes.");return}this.dialog.show();var g=this.dialog.getElementById("noteMenu");while(g.lastChild.value!="new"){g.removeChild(g.lastChild)}var h,e,b;var k=this._getOrderedNoteIds();for(var c=0;c<k.length;c++){b=k[c];h=f.createElement("option");h.setAttribute("value",b);e=this.notes[b];e=e.replace(/<[^>]*>/gi,"");if(e.length>50){e=e.substr(0,50)+"..."}e=this._getNumFromNoteId(b)+". "+e;h.appendChild(f.createTextNode(e));g.appendChild(h)}var a=this.dialog.getElementById("noteContent");a.disabled=false;a.focus();a.value=""};InsertNote.prototype.cursorInFootnote=function(a){var c=this.editor.getAllAncestors();for(var b=0;b<c.length;b++){if(c[b].id==this.NOTE_LIST_ID){return true}if(c[b].className==this.MARKER_CLASS&&!a){return true}}return false};InsertNote.prototype.repairNotes=function(){var m=this;var j;var e;var h;var f;var l;var k=this.editor._doc;this.repairScheduled=false;e=this._getMarkers();for(var g=0;g<e.length;g++){h=e[g];f=false;if(h){f=h.innerHTML.match(/^(<span[^>]*>)?(<sup>)?(<a[^>]*>)?[\s]*(<\/a>)?(<\/sup>)?(<\/span>)?$/m)}if(f){h.parentNode.removeChild(h)}var a=this._getIdFromMarkerId(h.id);if(!this.notes[a]){j=k.getElementById(a);if(j){this._saveNote(j)}else{if(h){h.parentNode.removeChild(h)}}}}for(var b in this.notes){j=k.getElementById(b);e=this._getMarkers(b);if(j){if(e.length==0){j.parentNode.removeChild(j);delete this.notes[b]}else{this._saveNote(j)}}else{for(var g=0;g<e.length;g++){e[g].parentNode.removeChild(e[g])}delete this.notes[b]}}this._updateRefNums();var c=k.getElementById(this.NOTE_LIST_ID);var d=this._createNoteList();if(d){c.parentNode.replaceChild(d,c)}else{if(c){c.parentNode.removeChild(c)}}};InsertNote.prototype._saveNote=function(c){var d=this.editor._doc;var a=d.getElementById(this._getLinkBackSpanId(c.id));if(a){a.parentNode.removeChild(a)}if(c.innerHTML){this.notes[c.id]=c.innerHTML}else{delete this.notes[c.id];markers=this._getMarkers(c.id);for(var b=0;b<markers.length;b++){markers[b].parentNode.removeChild(markers[b])}}};InsertNote.prototype._updateRefNums=function(){var a=1;var c;var b;var e;this.noteNums={};var f=this._getMarkers();for(var d=0;d<f.length;d++){b=f[d];e=this._getIdFromMarkerId(b.id);if(this.noteNums[e]){c=this.noteNums[e]}else{this.noteNums[e]=a;c=a++}b.firstChild.firstChild.innerHTML=c}};InsertNote.prototype.apply=function(){var i=this.editor;var e=this.dialog.hide();var a=e.noteMenu.value;var f=(a=="new");var c=e.noteContent;var j=i._doc;if(f){a=this._getNextId(this.ID_PREFIX)}this.notes[a]=c;var k=this._createNoteMarker(a);i.insertNodeAtSelection(k);var g=j.getElementById(k.id);var l=j.getElementById(this.NOTE_LIST_ID);var d=this._createNoteList();var h=j.body;if(l){h.replaceChild(d,l)}else{h.appendChild(d)}var b=j.createTextNode("\u00a0");if(g.nextSibling){b=g.parentNode.insertBefore(b,g.nextSibling)}else{b=g.parentNode.appendChild(b)}this.repairNotes();i.selectNodeContents(b,false)};InsertNote.prototype._createNoteList=function(){var d=this.editor._doc;var e=d.createElement("ol");e.id=this.NOTE_LIST_ID;var c=this._getOrderedNoteIds();if(c.length==0){return null}var b,f;for(var a=0;a<c.length;a++){f=c[a];b=this._createNoteNode(f,this.notes[f]);e.appendChild(b)}return e};InsertNote.prototype._createNoteMarker=function(b){var e=this.editor._doc;var f=this._getNumFromNoteId(b);var d=e.createElement("a");d.href="#"+b;d.innerHTML=f;var c=e.createElement("sup");c.appendChild(d);var a=e.createElement("span");a.id=this._getNextMarkerId(b);a.className=this.MARKER_CLASS;a.appendChild(c);return a};InsertNote.prototype._createNoteNode=function(a,b){var g=this.editor._doc;var e;var j=g.createElement("sup");var c=this._getMarkers(a);var k;for(var d=0;d<c.length;d++){e=g.createElement("a");if(c.length==1){e.innerHTML="^"}else{e.innerHTML=this._letterNum(d)}e.href="#"+c[d].id;j.appendChild(e);if(d<c.length-1){k=g.createTextNode(", ");j.appendChild(k)}}var f=g.createElement("span");f.id=this._getLinkBackSpanId(a);f.appendChild(j);var h=g.createElement("li");h.id=a;h.innerHTML=b;h.appendChild(f);return h};InsertNote.prototype._getNextId=function(a){var b=Xinha.uniq(a);while(this.editor._doc.getElementById(b)){b=Xinha.uniq(a)}return b};InsertNote.prototype._getOrderedNoteIds=function(){var a=this;var b=new Array();for(var c in this.notes){b.push(c)}b.sort(function(e,d){var g=a._getNumFromNoteId(e);var f=a._getNumFromNoteId(d);return(g-f)});return b};InsertNote.prototype._getNumFromNoteId=function(a){if(!this.noteNums[a]){return 0}return this.noteNums[a]};InsertNote.prototype._getMarkers=function(c){var d=this.editor._doc;var e=Xinha.getElementsByClassName(d,this.MARKER_CLASS);if(!c){return e}var b=new Array();for(var a=0;a<e.length;a++){if(this._getIdFromMarkerId(e[a].id)==c){b.push(e[a])}}return b};InsertNote.prototype._getNextMarkerId=function(a){return this._getNextId(a+this.MARKER_SUFFIX)};InsertNote.prototype._getIdFromMarkerId=function(a){return a.substr(0,a.search(this.MARKER_SUFFIX))};InsertNote.prototype._getLinkBackSpanId=function(a){return a+this.LINK_BACK_SUFFIX};InsertNote.prototype._lc=function(a){return Xinha._lc(a,"InsertNote")};InsertNote.prototype._letterNum=function(b){var e="abcdefghijklmnopqrstuvwxyz";var a=Math.floor(b/e.length)+1;var d="";for(var c=0;c<a;c++){d+=e.substr(b%e.length,1)}return d};InsertNote.prototype.inwardHtml=function(a){return a};InsertNote.prototype.outwardHtml=function(a){this.repairNotes();return this.editor.getHTML()};InsertNote.prototype.onKeyPress=function(b){if(b.keyCode==8||b.keyCode==46){var a=this;if(!this.repairScheduled&&!this.cursorInFootnote(true)){this.repairScheduled=true;window.setTimeout(function(){a.repairNotes()},1000)}}return false};InsertNote.prototype.onMode=function(a){return false};InsertNote.prototype.onBeforeMode=function(a){return false};