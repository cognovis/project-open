/* This compressed file is part of Xinha. For uncompressed sources, forum, and bug reports, go to xinha.org */
/* This file is part of version 0.96beta2 released Fri, 20 Mar 2009 11:01:14 +0100 */
(function(e){var c=window.PersistentStorage=function(h){this.editor=h;var g=this};c._pluginInfo={name:"PersistentStorage",version:"1.0",developer:"Douglas Mayle",developer_url:"http://douglas.mayle.org",license:"BSD"};c.prototype._backends={};c.prototype._userconfigs=[];c.prototype._activeBackend="";c.prototype._typeFilter="";c.prototype._viewType="thumbnail";c.prototype.onGenerateOnce=function(){this._prepareDialog()};function d(g,h){var i=new RegExp(" ?"+h+" ?");if(!i.test(g.className)){g.className+=" "+h}}function f(g,h){var i=new RegExp(" ?"+h+" ?");if(i.test(g.className)){g.className=g.className.replace(i," ")}}function a(g,h){var i=new RegExp(" ?"+h+" ?");if(i.test(g.className)){g.className=g.className.replace(i," ")}else{g.className+=" "+h}}c.prototype._registerDocumentUI=function(){if(this._documentEnabled){return}this._documentEnabled=true;var g=this;var h=this.editor;h.config.registerButton({id:"newdocument",tooltip:b._lc("New Document","PersistentStorage"),image:[_editor_url+h.config.imgURL+"ed_buttons_main.png",0,5],textMode:true,action:function(){g.newDocument()}});h.config.registerButton({id:"opendocument",tooltip:b._lc("Open Document","PersistentStorage"),image:[_editor_url+h.config.imgURL+"ed_buttons_main.png",1,5],textMode:true,action:function(){g.openDialog()}});h.config.registerButton({id:"savedocument",tooltip:b._lc("Save Document","PersistentStorage"),image:[_editor_url+h.config.imgURL+"ed_buttons_main.png",9,1],textMode:true,action:function(){g.saveDialog()}});h.config.addToolbarElement("newdocument","fullscreen",1);h.config.addToolbarElement("opendocument","newdocument",1);h.config.addToolbarElement("savedocument","opendocument",1);h._rebuildToolbar()};c.prototype.registerBackend=function(h,j,g,i){this._backends[h]={module:j,config:g,name:h};if(!this._activeBackend){this.setBackend(h)}if(g.capabilities.upload_operations&&g.capabilities.file_operations){this._registerDocumentUI()}if(i){this._userconfigs.push(i);this.configureUser()}this.updatePlacesDisplay()};c.prototype.configureUser=function(){var g=this;for(var i=0;i<this._userconfigs.length;++i){var h=this._userconfigs[i];for(var j in (h.plugins||{})){b.loadPlugin(j,function(){g.editor.registerPlugins([j]);b.refreshPlugin(g.editor.plugins[j].instance);g.editor._rebuildToolbar()},h.plugins[j])}}};c.prototype.newDocument=function(){if(this.editor._doc.body.lastChild){if(!confirm(b._lc("This will erase any unsaved content.  If you're certain, please click OK to continue.","PersistentStorage"))){return}}while(this.editor._doc.body.lastChild){this.editor._doc.body.removeChild(this.editor._doc.body.lastChild)}};c.prototype.saveDialog=function(){var h=this;var j=this.dialog.getElementById("h1");j.innerHTML=b._lc("Save Document","PersistentStorage");var i=this.dialog.getElementById("confirm");i.value=b._lc("Save","PersistentStorage");i.onclick=function(){h.saveDocument()};var g=this.dialog.getElementById("filename");i.disabled=g.value?false:true;g.onkeyup=g.onkeypress=g.onchange=function(){i.disabled=g.value?false:true};this.showDialog({typeFilter:["document","html","text","folder"],styleFor:"documentsave"})};c.prototype.saveDocument=function(){var i=this.editor;var h=this._backends[this._activeBackend].module;var g=this.dialog.getElementById("filename");h.saveDocument(h.viewFilter,g.value,i.getHTML(),function(){h.cache=null});this.dialog.hide()};c.prototype.openDialog=function(){var g=this;var i=this.dialog.getElementById("h1");i.innerHTML=b._lc("Open Document","PersistentStorage");var h=this.dialog.getElementById("confirm");h.value=b._lc("Open","PersistentStorage");h.onclick=function(){g.openDocument()};this.showDialog({typeFilter:["document","html","text","folder"],styleFor:"documentload"})};c.prototype.openDocument=function(){var h=this.editor;var g=this._backends[this._activeBackend].module;g.loadDocument(this.selectedEntry[0],function(i){h.setHTML(i)});this.dialog.hide()};c.prototype.showDialog=function(h){var g=this;if(!this.ready){window.setTimeout(function(){g.showDialog(h)},80);return}f(this.dialog.getElementById("WWW"),"hidden");d(this.dialog.getElementById("namefield"),"hidden");d(this.dialog.getElementById("placeWww"),"hidden");d(this.dialog.getElementById("placeBackend"),"hidden");switch(h.styleFor){case"link":f(this.dialog.getElementById("placeWww"),"hidden");this.updatePlacesDisplay("shared_publish");break;case"insertion":f(this.dialog.getElementById("placeBackend"),"hidden");this.updatePlacesDisplay("shared_publish");break;case"documentsave":d(this.dialog.getElementById("WWW"),"hidden");f(this.dialog.getElementById("namefield"),"hidden");f(this.dialog.getElementById("placeBackend"),"hidden");this.updatePlacesDisplay("file_operations");break;case"documentload":d(this.dialog.getElementById("WWW"),"hidden");f(this.dialog.getElementById("placeBackend"),"hidden");this.updatePlacesDisplay("file_operations");break}var k=this.dialog.getElementById("filters");var j=this.dialog.getElementById("fileList");this._typeFilter=h.typeFilter;var i=this._backends[this._activeBackend].module;this.updateFileBrowser()};c.prototype.displayFilters=function(k,j){var g=this.dialog.getElementById("filters");while(g.lastChild){g.removeChild(g.lastChild)}for(var h=0;h<k.length;++h){var i=document.createElement("option");i.setAttribute("value",k[h].value);if(k[h].value==j){i.setAttribute("selected","selected")}var l=document.createTextNode(k[h].display);i.appendChild(l);g.appendChild(i)}};c.prototype.buildThumbnail=function(l){var m=this;var g=this._backends[this._activeBackend].module;var o=document.createElement("div");o.entry=l;o.className="file";b._addEvent(o,"click",function(q){q=q||window.event;b._stopEvent(q);if(m.selectedEntry){f(m.selectedEntry[1],"selected");if(m.selectedEntry[1]==o){m.selectedEntry=null;return}}m.selectedEntry=[l,o];m.selectedEntry[1].className+=" selected";var p=m.dialog.getElementById("filename");p.value=l.name;var r=m.dialog.getElementById("confirm");r.disabled=false});var i=document.createElement("img");i.className="icon";if(l.$type=="image"){i.className="thumb";i.setAttribute("src",l.URL)}else{if(l.$type=="folder"){i.setAttribute("src",l.thumbURL||l.URL||this.editor.imgURL("images/tango/32x32/places/folder.png"))}else{if(l.$type=="document"){i.setAttribute("src",l.thumbURL||l.URL||this.editor.imgURL("images/tango/32x32/mimetypes/text-html.png"))}else{if(l.$type=="html"){i.setAttribute("src",l.thumbURL||l.URL||this.editor.imgURL("images/tango/32x32/mimetypes/text-html.png"))}else{if(l.$type=="txt"){i.setAttribute("src",l.thumbURL||l.URL||this.editor.imgURL("images/tango/32x32/mimetypes/text-g-generic.png"))}else{i.setAttribute("src",l.thumbURL||l.URL||this.editor.imgURL("images/tango/32x32/mimetypes/x-office-document.png"))}}}}}i=o.appendChild(i);var n=document.createElement("img");n.className="action delete";n.setAttribute("alt",b._lc("Delete","PersistentStorage"));n.setAttribute("title",b._lc("Delete","PersistentStorage"));n.setAttribute("src",this.editor.imgURL("images/tango/16x16/places/user-trash.png"));n=o.appendChild(n);b._addEvent(n,"click",function(p){p=p||window.event;b._stopEvent(p);g.deleteEntry(l,function(q){g.cache=null;if(q){o.parentNode.removeChild(o)}else{alert("Error deleting file "+l.name)}})});var j=document.createElement("p");j.className="filename";var k=document.createTextNode(l.name);k=j.appendChild(k);j=o.appendChild(j);j.onclick=function(p){return function(q){q=q||window.event;b._stopEvent(q);p.style.border="1px solid red";return false}}(j);var h=document.createElement("img");h.className="action copy";h.setAttribute("src",this.editor.imgURL("images/tango/16x16/actions/edit-copy.png"));h.setAttribute("alt",b._lc("Copy","PersistentStorage"));h.setAttribute("title",b._lc("Copy","PersistentStorage"));b._addEvent(h,"click",function(p){p=p||window.event;b._stopEvent(p);g.copyEntry(l,function(r,q){g.cache=null;if(r){o.parentNode.appendChild(m.buildThumbnail(q))}else{alert("Error copying file "+l.name)}})});h=o.appendChild(h);return o};c.prototype.displayBrowser=function(j){var m=this.dialog.getElementById("fileList");while(m.lastChild){m.removeChild(m.lastChild)}var k=this.editor;var h=this;for(var i=0;i<j.length;++i){switch(this._viewType){case"listing":break;case"thumbnail":default:var g=m.appendChild(this.buildThumbnail(j[i]));if(e&&e.ui&&e.ui.draggable&&e.ui.droppable){e(g).draggable({revert:true});if(j[i].$type=="folder"){e(g).droppable({accept:"*",drop:function(p,n){var o=this;n.draggable.each(function(){var r=this;var s=r.entry;var q=h._backends[h._activeBackend].module;q.moveEntry(s,o.entry,function(t){q.cache=null;if(t){r.parentNode.removeChild(r)}else{alert("Error deleting file "+s.name)}})})}})}}}}if(!m.firstChild){var l=document.createTextNode("No files found");m.appendChild(l)}};c.prototype.updateFileBrowser=function(){var g=this;var h=this._backends[this._activeBackend].module;var i=function(j){h.cache=j;var n=h.getFilters(h.cache);var m=true;if(h.viewFilter){for(var k=0;k<n.length;++k){if(n[k].value==h.viewFilter){m=false}}}if(m){h.viewFilter=n[0].value}var l=h.getMetadata(h.cache,h.viewFilter,g._typeFilter);g.dialog.show();g.displayFilters(n,h.viewFilter);g.displayBrowser(l)};if(h.cache){i(h.cache);return}h.loadData(i)};c.prototype._prepareDialog=function(){var h=this;var k=this.editor;if(!this.html){b._getback(b.getPluginDir("PersistentStorage")+"/dialog.html",function(o){h.html=o;h._prepareDialog()});return}this.dialog=new b.Dialog(k,this.html,"PersistentStorage",{width:800,closeOnEscape:true,resizable:true,centered:true,modal:true});this.dialog.getElementById("cancel").onclick=function(){h.dialog.hide()};this.dialog.getElementById("dirCreate").onclick=function(){var p=prompt(b._lc("Please enter the name of the directory you'd like to create.","PersistentStorage"));if(p){var o=h._backends[h._activeBackend].module;o.makeFolder(o.viewFilter,p,function(q){if(q){o.cache=null;h.updateFileBrowser()}})}};var n=this.dialog.getElementById("importlegend");var l=this.dialog.getElementById("import");n.onclick=function(){a(l,"collapsed")};var m=this.dialog.getElementById("WWW");b._addEvent(m,"click",function(p){p=p||window.event;b._stopEvent(p);for(var o=m.parentNode.firstChild;o;o=o.nextSibling){if(1!=o.nodeType){continue}f(o,"selected")}d(m,"selected");d(h.dialog.getElementById("placeBackend"),"hidden");f(h.dialog.getElementById("placeWww"),"hidden")});var j=this.dialog.getElementById("fileList");b._addEvent(j,"click",function(p){for(var o=j.firstChild;o;o=o.nextSibling){f(o,"selected")}});var i=this.dialog.getElementById("filters");i.onchange=function(){var o=h._backends[h._activeBackend].module;o.viewFilter=i.options[i.selectedIndex].value;h.updateFileBrowser()};var g=this.dialog.getElementById("viewType");g.onchange=function(){h._viewType=g.options[g.selectedIndex].value;h.updateFileBrowser()};this.ready=true};c.prototype.updatePlacesDisplay=function(j){var i=this;var k=this.dialog.getElementById("placesList");while(k.firstChild&&3==k.firstChild.nodeType){k.removeChild(k.firstChild)}var h=k.firstChild;while(h.nextSibling){k.removeChild(h.nextSibling)}for(var l in this._backends){if(j&&!this._backends[l].config.capabilities[j]){continue}var g=k.appendChild(this.placesIcon(this._backends[l]));if(e&&e.ui&&e.ui.draggable&&e.ui.droppable){e(g).droppable({accept:"*",drop:function(o,m){var n=this;m.draggable.each(function(){var q=this;var r=q.entry;var p=i._backends[i._activeBackend].module;p.loadDocument(r,function(s){n.backend.module.saveDocument(p.viewFilter,r.name,s,function(){n.backend.module.cache=null;p.deleteEntry(r,function(t){p.cache=null;if(t){q.parentNode.removeChild(q)}else{alert("Error deleting file "+r.name)}})})})})}})}}};c.prototype.setBackend=function(i){if(this._activeBackend==i){return}this._activeBackend=i;var h=this._backends[this._activeBackend];if(h.config.capabilities.import_operations){b._removeClass(this.dialog.getElementById("import"),"hidden");var g=this.dialog.getElementById("importui");while(g.firstChild){g.removeChild(g.firstChild)}h.module.buildImportUI(this.dialog,g)}else{b._addClass(this.dialog.getElementById("import"),"hidden")}};c.prototype.placesIcon=function(j){var h=this;var k=document.createElement("div");k.backend=j;k.className="file";if(this._activeBackend==j.name){k.className+=" selected"}b._addEvent(k,"click",function(n){n=n||window.event;b._stopEvent(n);for(var m=k.parentNode.firstChild;m;m=m.nextSibling){if(1!=m.nodeType){continue}f(m,"selected")}d(k,"selected");f(h.dialog.getElementById("placeBackend"),"hidden");d(h.dialog.getElementById("placeWww"),"hidden");h.setBackend(j.name);h.updateFileBrowser()});var l=document.createElement("img");l.className="icon";l.setAttribute("src",j.config.thumbURL||this.editor.imgURL("images/tango/32x32/places/network-server.png"));l=k.appendChild(l);var i=document.createElement("p");i.className="filename";var g=document.createTextNode(j.config.displayName||j.name);g=i.appendChild(g);i=k.appendChild(i);return k};var b=window.Xinha;b.prototype._insertImage=function(i){var h=this;var k=h.plugins.PersistentStorage.instance;var j=k.dialog.getElementById("h1");j.innerHTML=b._lc("Insert Image","PersistentStorage");var g=k.dialog.getElementById("confirm");g.value=b._lc("Insert","PersistentStorage");g.onclick=function(){k.insertImage()};k.showDialog({typeFilter:["image","folder"],styleFor:"insertion"})};c.prototype.insertImage=function(){var h=this.editor;this.dialog.hide();var i=h._doc.createElement("img");if(this.selectedEntry){i.setAttribute("src",this.selectedEntry[0].URL)}else{i.setAttribute("src",this.dialog.getElementById("URL").value)}for(var k in {width:"",height:"",margin:"",padding:"",border:"",borderColor:"",backgroundColor:""}){var j=this.dialog.getElementById("image_"+k).value.replace(/^\s+$/,"");if(j){i.style[k]=j}}h.insertNodeAtSelection(i);var g=h.createRange(h.getSelection());g.collapse(false)}})(window.jQuery);